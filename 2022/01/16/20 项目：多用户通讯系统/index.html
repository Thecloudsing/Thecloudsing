<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>&lt;Java&gt;20 项目（多用户通讯系统） | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="20 项目：多用户通讯系统 项目见（多用户通讯系统） 服务端启动位置（多用户通讯系统\项目：通讯系统（服务端）\src\com\melody\transmission\common\ClientConnect.java） 客户端启动位置（项目：通讯系统（客户端）\src\com\melody\transmission\Test1.java）  20.1 需求分析 用户登录 拉取在线用户列表 无异常">
<meta property="og:type" content="article">
<meta property="og:title" content="&lt;Java&gt;20 项目（多用户通讯系统）">
<meta property="og:url" content="http://example.com/2022/01/16/20%20%E9%A1%B9%E7%9B%AE%EF%BC%9A%E5%A4%9A%E7%94%A8%E6%88%B7%E9%80%9A%E8%AE%AF%E7%B3%BB%E7%BB%9F/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="20 项目：多用户通讯系统 项目见（多用户通讯系统） 服务端启动位置（多用户通讯系统\项目：通讯系统（服务端）\src\com\melody\transmission\common\ClientConnect.java） 客户端启动位置（项目：通讯系统（客户端）\src\com\melody\transmission\Test1.java）  20.1 需求分析 用户登录 拉取在线用户列表 无异常">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2022-01-15T16:00:00.000Z">
<meta property="article:modified_time" content="2022-05-23T23:51:12.598Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="笔记">
<meta property="article:tag" content="程序">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-20 项目：多用户通讯系统" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/01/16/20%20%E9%A1%B9%E7%9B%AE%EF%BC%9A%E5%A4%9A%E7%94%A8%E6%88%B7%E9%80%9A%E8%AE%AF%E7%B3%BB%E7%BB%9F/" class="article-date">
  <time class="dt-published" datetime="2022-01-15T16:00:00.000Z" itemprop="datePublished">2022-01-16</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Java/">Java</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      &lt;Java&gt;20 项目（多用户通讯系统）
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="20-项目：多用户通讯系统"><a href="#20-项目：多用户通讯系统" class="headerlink" title="20 项目：多用户通讯系统"></a>20 项目：多用户通讯系统</h1><blockquote>
<p><strong>项目见（多用户通讯系统）</strong></p>
<p>服务端启动位置（多用户通讯系统\项目：通讯系统（服务端）\src\com\melody\transmission\common\ClientConnect.java）</p>
<p>客户端启动位置（项目：通讯系统（客户端）\src\com\melody\transmission\Test1.java）</p>
</blockquote>
<h2 id="20-1-需求分析"><a href="#20-1-需求分析" class="headerlink" title="20.1 需求分析"></a>20.1 需求分析</h2><ol>
<li>用户登录</li>
<li>拉取在线用户列表</li>
<li>无异常退出（客户端、服务端）</li>
<li>私聊</li>
<li>群聊</li>
<li>发文件</li>
<li>服务器推送新闻</li>
</ol>
<h3 id="20-1-1-登录"><a href="#20-1-1-登录" class="headerlink" title="20.1.1 登录"></a>20.1.1 登录</h3><p><strong>服务端</strong></p>
<ol>
<li>客户端连接到服务器后，会得到一个 <code>Socket</code></li>
<li>启动一个线程，该线程持有该 <code>Socket</code> 对象</li>
<li>为了更好地管理线程，需要使用集合来管理</li>
</ol>
<p><strong>客户端</strong></p>
<ol>
<li>和服务端通信时，使用对象方式，可以使用对象流来读写</li>
<li>客户端连接到服务端后，也会得到 <code>Socket</code></li>
<li>启动一个线程，该线程持有该 <code>Socket</code> 对象</li>
<li>为了更好地管理线程，需要使用集合来管理</li>
</ol>
<h3 id="20-1-2-无异常退出"><a href="#20-1-2-无异常退出" class="headerlink" title="20.1.2 无异常退出"></a>20.1.2 无异常退出</h3><blockquote>
<p>写下面内容的之前，我已经把代码都完成了。</p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1fh411y7R8?p=688&t=0.8">韩老师的思路</a>都是最基本的思路，这些其实应该不参考笔记自己去想。</p>
<p>想不通的地方才看答案（笔记），我认为是比较好的方法。</p>
</blockquote>
<p><strong>服务端</strong></p>
<ol>
<li>服务器端和某个客户端通信的线程接到一个退出请求后，关闭 socket 并退出线程</li>
</ol>
<p><strong>客户端</strong></p>
<ol>
<li>调用方法，向服务端发送登出请求，之后客户端调用方法正常退出</li>
</ol>
<h3 id="下略"><a href="#下略" class="headerlink" title="下略"></a>下略</h3><blockquote>
<p>没记</p>
</blockquote>
<h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><h3 id="多用户通讯系统"><a href="#多用户通讯系统" class="headerlink" title="多用户通讯系统"></a>多用户通讯系统</h3><p>开始写的时候思路没整理好，最后乱七八糟的</p>
<p>又没什么注释，所以别往下翻了</p>
<h4 id="通用部分（客户端-amp-服务端）"><a href="#通用部分（客户端-amp-服务端）" class="headerlink" title="通用部分（客户端 &amp; 服务端）"></a>通用部分（客户端 &amp; 服务端）</h4><blockquote>
<p>MyTools.java：工具类</p>
<p>UserData.java：用户数据类，包含完整的用户信息。这些信息存储在服务端。每个客户端只可能在验证通过的场合，持有最多一个来自服务端的属于客户自己的该类对象</p>
<p>User.java：简易的用户类。只是用以传递一组账号和密码。一般由客户端发送往服务端。这些账号和密码未必是正确的。</p>
<p>Message.java：数据包。客户端和服务端的所有通信都以传递该数据包的形式进行。</p>
<p>MessageType.java：代码表。客户端和服务端各自持有一份相同的该表，用以对数据包进行识别。</p>
</blockquote>
<ul>
<li><p><strong>MyTools.java</strong></p>
<p>精简了一下放上来</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyTools</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Scanner</span> <span class="variable">inp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//这个方法能读取一个 输入流 的内容</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] whatInputIs(InputStream is) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="keyword">while</span> ((len = is.read(bytes, <span class="number">0</span>, bytes.length)) != -<span class="number">1</span>) &#123;</span><br><span class="line">            bis.write(bytes, <span class="number">0</span>, len);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bis.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>User.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.melody.transmission.common;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Melody</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="keyword">private</span> String pw;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">User</span><span class="params">(String id, String pw)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">        <span class="built_in">this</span>.pw = pw;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setId</span><span class="params">(String id)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPw</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> pw;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPw</span><span class="params">(String pw)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.pw = pw;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>UserData.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.melody.transmission.common;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.util.Objects;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Melody</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserData</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String ID;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String pw;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">online</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">private</span> String[] friendID;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">StringBuilder</span> <span class="variable">leftMessage</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line"></span><br><span class="line">    UserData(String name, String pw, String ID) &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.pw = pw;</span><br><span class="line">        <span class="built_in">this</span>.ID = ID;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ID;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPw</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> pw;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPw</span><span class="params">(String pw)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.pw = pw;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isOnline</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> online;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setOnline</span><span class="params">(<span class="type">boolean</span> online)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.online = online;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">listed</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ((online ? <span class="string">&quot;·在线&quot;</span> : <span class="string">&quot;离线中&quot;</span>) + <span class="string">&quot;\t用户名：（&quot;</span> + ID + <span class="string">&quot;）&quot;</span> + name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span> == o) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (o == <span class="literal">null</span> || getClass() != o.getClass()) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="type">UserData</span> <span class="variable">userData</span> <span class="operator">=</span> (UserData) o;</span><br><span class="line">        <span class="keyword">return</span> online == userData.online &amp;&amp; Objects.equals(ID, userData.ID) &amp;&amp; Objects.equals(name, userData.name) &amp;&amp; Objects.equals(pw, userData.pw);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Objects.hash(ID, name, pw, online);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Message.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.melody.transmission.common;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Melody</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Message</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span>, MessageType &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line">    <span class="keyword">private</span> String time;</span><br><span class="line">    <span class="keyword">private</span> String sender;</span><br><span class="line">    <span class="keyword">private</span> String receiver;</span><br><span class="line">    <span class="keyword">private</span> String messageType;</span><br><span class="line">    <span class="keyword">private</span> Object object;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Message</span><span class="params">(String message, String sender, String receiver, String messageType)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.message = message;</span><br><span class="line">        <span class="built_in">this</span>.time = getDateTime();</span><br><span class="line">        <span class="built_in">this</span>.sender = sender;</span><br><span class="line">        <span class="built_in">this</span>.receiver = receiver;</span><br><span class="line">        <span class="built_in">this</span>.messageType = messageType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getObject</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setObject</span><span class="params">(Object object)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.object = object;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getMessage</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMessage</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.message = message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTime</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> time;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTime</span><span class="params">(String time)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.time = time;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getSender</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSender</span><span class="params">(String sender)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.sender = sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getReceiver</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> receiver;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setReceiver</span><span class="params">(String receiver)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.receiver = receiver;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getMessageType</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> messageType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMessageType</span><span class="params">(String messageType)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.messageType = messageType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">getDate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> getDate(LocalDateTime.now());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">getDate</span><span class="params">(LocalDateTime ldt)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">mon</span> <span class="operator">=</span> ldt.getMonthValue();</span><br><span class="line">        <span class="type">int</span> <span class="variable">day</span> <span class="operator">=</span> ldt.getDayOfMonth();</span><br><span class="line">        <span class="keyword">return</span> ldt.getYear() + <span class="string">&quot;.&quot;</span> + (mon &lt; <span class="number">10</span> ? <span class="string">&quot;0&quot;</span> + mon : mon) + <span class="string">&quot;.&quot;</span> + (day &lt; <span class="number">10</span> ? <span class="string">&quot;0&quot;</span> + day : day);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">time</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> time(LocalDateTime.now());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">time</span><span class="params">(LocalDateTime ldt)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">hour</span> <span class="operator">=</span> ldt.getHour();</span><br><span class="line">        <span class="type">int</span> <span class="variable">min</span> <span class="operator">=</span> ldt.getMinute();</span><br><span class="line">        <span class="type">int</span> <span class="variable">sec</span> <span class="operator">=</span> ldt.getSecond();</span><br><span class="line">        <span class="keyword">return</span> (hour &lt; <span class="number">10</span> ? <span class="string">&quot;0&quot;</span> + hour : hour) + <span class="string">&quot;:&quot;</span> + (min &lt; <span class="number">10</span> ? <span class="string">&quot;0&quot;</span> + min : min) + <span class="string">&quot;:&quot;</span> + (sec &lt; <span class="number">10</span> ? <span class="string">&quot;0&quot;</span> + sec : sec);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getDateTime</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">ldt</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">        <span class="keyword">return</span> getDate(ldt) + <span class="string">&quot;  &quot;</span> + time();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>MessageType.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.melody.transmission.common;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Melody</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MessageType</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">LOGIN_SUCCESS</span> <span class="operator">=</span> <span class="string">&quot;lS&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">LOGIN_FAILED</span> <span class="operator">=</span> <span class="string">&quot;lF&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">LOGIN_USER_NOT_EXIST</span> <span class="operator">=</span> <span class="string">&quot;lU&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">LOGIN_WRONG_PW</span> <span class="operator">=</span> <span class="string">&quot;lP&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">LOGGED_SHOW_LIST</span> <span class="operator">=</span> <span class="string">&quot;11SL&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">LOGGED_SHOW_ONLINE_LIST</span> <span class="operator">=</span> <span class="string">&quot;11SO&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">CHAT</span> <span class="operator">=</span> <span class="string">&quot;CM&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">GROUP_CHAT</span> <span class="operator">=</span> <span class="string">&quot;GM&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">FILE</span> <span class="operator">=</span> <span class="string">&quot;CF&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">LOGGED_CHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;15CN&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">LOGGED_CHANGE_PW</span> <span class="operator">=</span> <span class="string">&quot;16CP&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">LOGGED_CHANGE_HIDE</span> <span class="operator">=</span> <span class="string">&quot;17CH&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">LOGGED_LOGOUT</span> <span class="operator">=</span> <span class="string">&quot;19OT&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">REQUEST_ALLOWED</span> <span class="operator">=</span> <span class="string">&quot;RE&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">REQUEST_REJECTED</span> <span class="operator">=</span> <span class="string">&quot;RR&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">REPEAT_LOGIN</span> <span class="operator">=</span> <span class="string">&quot;EXC_RL&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h4><blockquote>
<p>ClientConnet.java：入口</p>
<p>ClientLogin.java：管理所有登录活动。该线程将持续监听用户登录。用户登录成功后启动一个专用的会话线程。</p>
<p>Serve.java：这就是那个专用会话线程。会持续监听用户请求，并作出反应。</p>
<p>ServeCollection.java：该类收集所有活动中的 Serve 线程。</p>
<p>UserDataEnum.java：记录所有用户数据的枚举类。数据库的替代方法（还没学数据库）</p>
</blockquote>
<ul>
<li><p><strong>ClientConnet.java（入口）</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.melody.transmission.common;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.melody.transmission.login.ClientLogin;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Melody</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClientConnect</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">thisIP</span> <span class="operator">=</span> <span class="string">&quot;192.168.3.16&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> HashMap&lt;String, UserData&gt; data = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> HashMap&lt;String, Socket&gt; sockets = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (UserDataEnum userData : UserDataEnum.values()) &#123;</span><br><span class="line">            data.put(userData.user.getId(), userData.user);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">ClientLogin</span>()).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>ClientLogin.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.melody.transmission.login;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.melody.transmission.common.*;</span><br><span class="line"><span class="keyword">import</span> com.melody.transmission.connected.Serve;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.InetAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.ServerSocket;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Melody</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClientLogin</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ServerSocket</span> <span class="variable">serverSocket</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            serverSocket = <span class="keyword">new</span> <span class="title class_">ServerSocket</span>(<span class="number">9000</span>);</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                login(serverSocket);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">login</span><span class="params">(ServerSocket serverSocket)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Socket</span> <span class="variable">clientSocket</span> <span class="operator">=</span> serverSocket.accept();</span><br><span class="line"></span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(clientSocket.getInputStream());</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(clientSocket.getOutputStream());</span><br><span class="line"></span><br><span class="line">        String checkRes;</span><br><span class="line">        <span class="type">User</span> <span class="variable">clientUser</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">Message</span> <span class="variable">toSend</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>(<span class="literal">null</span>, InetAddress.getLocalHost().getHostAddress(), clientSocket.getInetAddress().getHostAddress(), <span class="literal">null</span>);</span><br><span class="line">        toSend.setObject(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            clientUser = (User) ois.readObject();</span><br><span class="line">            checkRes = checkUserData(clientUser);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            checkRes = MessageType.LOGIN_FAILED;</span><br><span class="line">        &#125;</span><br><span class="line">        toSend.setMessageType(checkRes);</span><br><span class="line">        <span class="keyword">if</span> (checkRes.equals(MessageType.LOGIN_SUCCESS)) &#123;</span><br><span class="line">            ClientConnect.data.get(clientUser.getId()).setOnline(<span class="literal">true</span>);</span><br><span class="line">            toSend.setObject(ClientConnect.data.get(clientUser.getId()));</span><br><span class="line">            oos.writeObject(toSend);</span><br><span class="line">            <span class="type">Serve</span> <span class="variable">serve</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Serve</span>(clientSocket, oos, ois, clientUser.getId());</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(serve).start();</span><br><span class="line"><span class="comment">//            ClientSocketsCollection.addSocket(clientUser.getId(), clientSocket);</span></span><br><span class="line">            ServeCollection.add(clientUser.getId(), serve);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            oos.writeObject(toSend);</span><br><span class="line">            oos.close();</span><br><span class="line">            ois.close();</span><br><span class="line">            clientSocket.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">checkUserData</span><span class="params">(User inp)</span> &#123;</span><br><span class="line">        <span class="type">UserData</span> <span class="variable">inpIDUser</span> <span class="operator">=</span> ClientConnect.data.get(inp.getId());</span><br><span class="line">        <span class="keyword">if</span> (inpIDUser == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> MessageType.LOGIN_USER_NOT_EXIST;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!inpIDUser.getPw().equals(inp.getPw())) &#123;</span><br><span class="line">            <span class="keyword">return</span> MessageType.LOGIN_WRONG_PW;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Serve</span> <span class="variable">temp</span> <span class="operator">=</span> ServeCollection.get(inpIDUser.getId());</span><br><span class="line">        <span class="keyword">if</span> (temp != <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                temp.sendRepeatLoginException();</span><br><span class="line">                System.out.println(Message.getDateTime() + <span class="string">&quot; &quot;</span> + temp.id + <span class="string">&quot; 重复登陆&quot;</span>);</span><br><span class="line">                temp.forceLogout();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                <span class="keyword">return</span> MessageType.LOGIN_FAILED;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> MessageType.LOGIN_SUCCESS;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Serve.java（主干）</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.melody.transmission.connected;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.melody.transmission.common.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Melody</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Serve</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Socket clientSocket;</span><br><span class="line">    <span class="keyword">private</span> ObjectOutputStream oos;</span><br><span class="line">    <span class="keyword">private</span> ObjectInputStream ois;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">connecting</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Serve</span><span class="params">(Socket clientSocket, ObjectOutputStream oos, ObjectInputStream ois, String id)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.clientSocket = clientSocket;</span><br><span class="line">        <span class="built_in">this</span>.oos = oos;</span><br><span class="line">        <span class="built_in">this</span>.ois = ois;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(Message.getDateTime() + <span class="string">&quot; &quot;</span> + id + <span class="string">&quot; 登录 &quot;</span> + clientSocket.getLocalAddress().getHostName());</span><br><span class="line">        ClientConnect.data.get(id).setOnline(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">while</span> (connecting) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                serve();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException | ClassNotFoundException e) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    forceLogout();</span><br><span class="line">                    System.out.println(Message.getDateTime() + <span class="string">&quot; &quot;</span> + id + <span class="string">&quot; 系统强行登出 &quot;</span> + e.toString());</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">                    ex.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">serve</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">Message</span> <span class="variable">inp</span> <span class="operator">=</span> (Message) ois.readObject();</span><br><span class="line">        <span class="type">Message</span> <span class="variable">toSend</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>(<span class="literal">null</span>, ClientConnect.thisIP, clientSocket.getInetAddress().getHostAddress(), <span class="literal">null</span>);</span><br><span class="line">        <span class="keyword">if</span> (inp == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (inp.getMessageType().equals(MessageType.LOGGED_SHOW_LIST)) &#123;</span><br><span class="line">            sendList(inp, toSend);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (inp.getMessageType().equals(MessageType.LOGGED_CHANGE_NAME)) &#123;</span><br><span class="line">            setNewName(inp, toSend);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (inp.getMessageType().equals(MessageType.LOGGED_CHANGE_HIDE)) &#123;</span><br><span class="line">            changeHide(inp, toSend);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (inp.getMessageType().equals(MessageType.LOGGED_CHANGE_PW)) &#123;</span><br><span class="line">            changPw(inp, toSend);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (inp.getMessageType().equals(MessageType.LOGGED_SHOW_ONLINE_LIST)) &#123;</span><br><span class="line">            sendOnlineList(inp, toSend);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (inp.getMessageType().equals(MessageType.CHAT)) &#123;</span><br><span class="line">            chat(inp, toSend);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (inp.getMessageType().equals(MessageType.GROUP_CHAT)) &#123;</span><br><span class="line">            groupChat(inp, toSend);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (inp.getMessageType().equals(MessageType.LOGGED_LOGOUT)) &#123;</span><br><span class="line">            logout(inp);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (inp.getMessageType().equals(MessageType.FILE)) &#123;</span><br><span class="line">            sendFile(inp, toSend);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sendList</span><span class="params">(Message inp, Message toSend)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="keyword">for</span> (UserData userData : ClientConnect.data.values()) &#123;</span><br><span class="line">            sb.append(userData.listed());</span><br><span class="line">            sb.append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        toSend.setMessage(sb.toString());</span><br><span class="line">        toSend.setMessageType(MessageType.REQUEST_ALLOWED);</span><br><span class="line">        oos.writeObject(toSend);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sendOnlineList</span><span class="params">(Message inp, Message toSend)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="keyword">for</span> (UserData userData : ClientConnect.data.values()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (userData.isOnline()) &#123;</span><br><span class="line">                sb.append(userData.listed());</span><br><span class="line">                sb.append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        toSend.setMessage(sb.toString());</span><br><span class="line">        toSend.setMessageType(MessageType.REQUEST_ALLOWED);</span><br><span class="line">        oos.writeObject(toSend);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setNewName</span><span class="params">(Message inp, Message toSend)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">newName</span> <span class="operator">=</span> inp.getMessage();</span><br><span class="line">        <span class="type">UserData</span> <span class="variable">temp</span> <span class="operator">=</span> (UserData) inp.getObject();</span><br><span class="line">        <span class="keyword">if</span> (!temp.getId().equals(id) || !temp.equals(ClientConnect.data.get(id))) &#123;</span><br><span class="line">            toSend.setMessageType(MessageType.REQUEST_REJECTED);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            temp.setName(newName);</span><br><span class="line">            ClientConnect.data.put(id, temp);</span><br><span class="line">            toSend.setObject(ClientConnect.data.get(temp.getId()));</span><br><span class="line">            toSend.setMessageType(MessageType.REQUEST_ALLOWED);</span><br><span class="line">        &#125;</span><br><span class="line">        oos.writeObject(toSend);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">changPw</span><span class="params">(Message inp, Message toSend)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">newPw</span> <span class="operator">=</span> inp.getMessage();</span><br><span class="line">        <span class="type">UserData</span> <span class="variable">temp</span> <span class="operator">=</span> (UserData) inp.getObject();</span><br><span class="line">        <span class="keyword">if</span> (!temp.getId().equals(id) || !temp.equals(ClientConnect.data.get(id))) &#123;</span><br><span class="line">            toSend.setMessageType(MessageType.REQUEST_REJECTED);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            temp.setPw(newPw);</span><br><span class="line">            ClientConnect.data.put(id, temp);</span><br><span class="line">            toSend.setObject(ClientConnect.data.get(id));</span><br><span class="line">            toSend.setMessageType(MessageType.REQUEST_ALLOWED);</span><br><span class="line">        &#125;</span><br><span class="line">        oos.writeObject(toSend);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">changeHide</span><span class="params">(Message inp, Message toSend)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">UserData</span> <span class="variable">temp</span> <span class="operator">=</span> (UserData) inp.getObject();</span><br><span class="line">        <span class="keyword">if</span> (!temp.getId().equals(id) || !temp.equals(ClientConnect.data.get(id))) &#123;</span><br><span class="line">            toSend.setMessageType(MessageType.REQUEST_REJECTED);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            temp.setOnline(!temp.isOnline());</span><br><span class="line">            ClientConnect.data.put(id, temp);</span><br><span class="line">            toSend.setObject(ClientConnect.data.get(temp.getId()));</span><br><span class="line">            toSend.setMessageType(MessageType.REQUEST_ALLOWED);</span><br><span class="line">        &#125;</span><br><span class="line">        oos.writeObject(toSend);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">chat</span><span class="params">(Message inp, Message toSend)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        User[] users = (User[]) inp.getObject();</span><br><span class="line">        <span class="keyword">if</span> (!users[<span class="number">0</span>].getId().equals(id) || !users[<span class="number">0</span>].getPw().equals(ClientConnect.data.get(id).getPw())) &#123;</span><br><span class="line">            toSend.setMessageType(MessageType.REQUEST_REJECTED);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (users[<span class="number">1</span>].getId().equals(id) || ClientConnect.data.get(users[<span class="number">1</span>].getId()) == <span class="literal">null</span>) &#123;</span><br><span class="line">            toSend.setMessageType(MessageType.REQUEST_REJECTED);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">UserData</span> <span class="variable">tar</span> <span class="operator">=</span> ClientConnect.data.get(users[<span class="number">1</span>].getId());</span><br><span class="line">            <span class="type">UserData</span> <span class="variable">form</span> <span class="operator">=</span> ClientConnect.data.get(id);</span><br><span class="line">            <span class="type">StringBuilder</span> <span class="variable">send</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">            toSend.setMessageType(MessageType.CHAT);</span><br><span class="line">            send.append(inp.getTime()).append(<span class="string">&quot; &quot;</span>).append(form.getName()).append(<span class="string">&quot; 对 你 说：&quot;</span>).append(inp.getMessage());</span><br><span class="line">            <span class="keyword">if</span> (ServeCollection.get(tar.getId()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                toSend.setMessage(send.toString());</span><br><span class="line">                ServeCollection.get(tar.getId()).oos.writeObject(toSend);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ClientConnect.data.get(tar.getId()).leftMessage.append(send).append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            toSend.setObject(<span class="keyword">new</span> <span class="title class_">User</span>(tar.getName(), <span class="literal">null</span>));</span><br><span class="line">            toSend.setMessageType(MessageType.REQUEST_ALLOWED);</span><br><span class="line">        &#125;</span><br><span class="line">        oos.writeObject(toSend);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">groupChat</span><span class="params">(Message inp, Message toSend)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> (User) inp.getObject();</span><br><span class="line">        <span class="keyword">if</span> (!user.getId().equals(id) || !user.getPw().equals(ClientConnect.data.get(id).getPw())) &#123;</span><br><span class="line">            toSend.setMessageType(MessageType.REQUEST_REJECTED);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            toSend.setMessageType(MessageType.GROUP_CHAT);</span><br><span class="line">            <span class="type">String</span> <span class="variable">word</span> <span class="operator">=</span> <span class="string">&quot;[群发]&quot;</span> + inp.getTime() + <span class="string">&quot; &quot;</span> + ClientConnect.data.get(id).getName() +</span><br><span class="line">                    <span class="string">&quot; 说：&quot;</span> + inp.getMessage();</span><br><span class="line">            toSend.setMessage(word);</span><br><span class="line">            <span class="keyword">for</span> (Serve serve : ServeCollection.toValue()) &#123;</span><br><span class="line">                serve.oos.writeObject(toSend);</span><br><span class="line">            &#125;</span><br><span class="line">            toSend.setMessageType(MessageType.REQUEST_ALLOWED);</span><br><span class="line">        &#125;</span><br><span class="line">        oos.writeObject(toSend);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sendFile</span><span class="params">(Message inp, Message toSend)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(id, inp.getSender());</span><br><span class="line">        <span class="keyword">if</span> (!user.getPw().equals(ClientConnect.data.get(id).getPw())) &#123;</span><br><span class="line">            toSend.setMessageType(MessageType.REQUEST_REJECTED);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (inp.getReceiver().equals(id) || ClientConnect.data.get(inp.getReceiver()) == <span class="literal">null</span>) &#123;</span><br><span class="line">            toSend.setMessageType(MessageType.REQUEST_REJECTED);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            toSend.setMessageType(MessageType.FILE);</span><br><span class="line">            toSend.setMessage(inp.getMessage());</span><br><span class="line">            toSend.setSender(id);</span><br><span class="line">            toSend.setReceiver(inp.getReceiver());</span><br><span class="line">            toSend.setObject(inp.getObject());</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ServeCollection.get(inp.getReceiver()).oos.writeObject(toSend);</span><br><span class="line">                toSend.setMessageType(MessageType.REQUEST_ALLOWED);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                toSend.setMessageType(MessageType.REQUEST_REJECTED);</span><br><span class="line">            &#125;</span><br><span class="line">            toSend.setObject(<span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        oos.writeObject(toSend);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">logout</span><span class="params">(Message inp)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">UserData</span> <span class="variable">temp</span> <span class="operator">=</span> (UserData) inp.getObject();</span><br><span class="line">        <span class="keyword">if</span> (!temp.getId().equals(id) || !temp.equals(ClientConnect.data.get(id))) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ClientConnect.data.get(id).setOnline(<span class="literal">false</span>);</span><br><span class="line">            ois.close();</span><br><span class="line">            oos.close();</span><br><span class="line">            clientSocket.close();</span><br><span class="line">            connecting = <span class="literal">false</span>;</span><br><span class="line">            ServeCollection.remove(id);</span><br><span class="line">            System.out.println(Message.getDateTime() + <span class="string">&quot; &quot;</span> + id + <span class="string">&quot; 用户登出 &quot;</span> + clientSocket.getInetAddress().getHostName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">forceLogout</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        ClientConnect.data.get(id).setOnline(<span class="literal">false</span>);</span><br><span class="line">        ois.close();</span><br><span class="line">        oos.close();</span><br><span class="line">        clientSocket.close();</span><br><span class="line">        connecting = <span class="literal">false</span>;</span><br><span class="line">        ServeCollection.remove(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendRepeatLoginException</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        oos.writeObject(<span class="keyword">new</span> <span class="title class_">Message</span>(<span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, MessageType.REPEAT_LOGIN));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>ServeCollection.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.melody.transmission.common;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.melody.transmission.connected.Serve;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Melody</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServeCollection</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> HashMap&lt;String, Serve&gt; serves = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">(String id, Serve serve)</span>&#123;</span><br><span class="line">        serves.put(id, serve);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Serve <span class="title function_">get</span><span class="params">(String id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> serves.get(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Collection&lt;Serve&gt; <span class="title function_">toValue</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> serves.values();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">remove</span><span class="params">(String id)</span>&#123;</span><br><span class="line">        serves.remove(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>UserDataEnum.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.melody.transmission.common;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Melody</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">UserDataEnum</span> &#123;</span><br><span class="line">    USER01(<span class="string">&quot;申鹤&quot;</span>, <span class="string">&quot;123456&quot;</span>, <span class="string">&quot;0001&quot;</span>),</span><br><span class="line">    USER02(<span class="string">&quot;胡桃&quot;</span>, <span class="string">&quot;123456&quot;</span>, <span class="string">&quot;0002&quot;</span>),</span><br><span class="line">    USER03(<span class="string">&quot;甘雨&quot;</span>, <span class="string">&quot;123456&quot;</span>, <span class="string">&quot;0003&quot;</span>),</span><br><span class="line">    USER04(<span class="string">&quot;刻晴&quot;</span>, <span class="string">&quot;123456&quot;</span>, <span class="string">&quot;0004&quot;</span>),</span><br><span class="line">    USER05(<span class="string">&quot;香菱&quot;</span>, <span class="string">&quot;123456&quot;</span>, <span class="string">&quot;0005&quot;</span>),</span><br><span class="line">    USER06(<span class="string">&quot;凝光&quot;</span>, <span class="string">&quot;123456&quot;</span>, <span class="string">&quot;0006&quot;</span>),</span><br><span class="line">    USER07(<span class="string">&quot;云堇&quot;</span>, <span class="string">&quot;123456&quot;</span>, <span class="string">&quot;0007&quot;</span>),</span><br><span class="line">    USER08(<span class="string">&quot;留云借风真君&quot;</span>, <span class="string">&quot;123456&quot;</span>, <span class="string">&quot;0008&quot;</span>),</span><br><span class="line">    USER09(<span class="string">&quot;降魔大圣&quot;</span>, <span class="string">&quot;123456&quot;</span>, <span class="string">&quot;0009&quot;</span>),</span><br><span class="line">    USER10(<span class="string">&quot;歌尘浪市真君&quot;</span>, <span class="string">&quot;123456&quot;</span>, <span class="string">&quot;0010&quot;</span>),</span><br><span class="line">    USER11(<span class="string">&quot;理水叠山真君&quot;</span>, <span class="string">&quot;123456&quot;</span>, <span class="string">&quot;0011&quot;</span>),</span><br><span class="line">    USER12(<span class="string">&quot;摩拉克斯&quot;</span>, <span class="string">&quot;123456&quot;</span>, <span class="string">&quot;0012&quot;</span>),</span><br><span class="line">    USER13(<span class="string">&quot;救苦渡厄真君&quot;</span>, <span class="string">&quot;123456&quot;</span>, <span class="string">&quot;0013&quot;</span>);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> UserData user;</span><br><span class="line"></span><br><span class="line">    UserDataEnum(String name, String pw, String ID) &#123;</span><br><span class="line">        user = <span class="keyword">new</span> <span class="title class_">UserData</span>(name, pw, ID);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h4><blockquote>
<p>Test1.java：程序入口</p>
<p>ClientInterface.java：程序的主干</p>
<p>ClientThread.java：由这个线程收集服务端发来的数据，并记录</p>
<p>ClientThreadCollection.java：思路混乱的产物。现在我也不知道这是干嘛的（好在没几行代码）</p>
<p>Utility.java：工具类</p>
</blockquote>
<ul>
<li><p><strong>Test1.java（入口）</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.melody.transmission;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.melody.transmission.common.ClientInterface;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Melody</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ClientInterface</span>().menu_0();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>ClientInterface.java（主干）</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.melody.transmission.common;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.InetAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Melody</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClientInterface</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Scanner</span> <span class="variable">scanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">thisIP</span> <span class="operator">=</span> <span class="string">&quot;192.168.3.16&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">serverIP</span> <span class="operator">=</span> <span class="string">&quot;192.168.3.16&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">UserData</span> <span class="variable">loggedUser</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> ClientThread ct;</span><br><span class="line">    <span class="keyword">private</span> Socket socket;</span><br><span class="line">    <span class="keyword">private</span> Message message;</span><br><span class="line">    ObjectOutputStream oos;</span><br><span class="line">    ObjectInputStream ois;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="variable">running</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="variable">cancelMenu</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">File</span> <span class="variable">filePath</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;d:\\&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//一级菜单、登录</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">menu_0</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">running0</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">while</span> (running0) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;===========欢迎使用通讯系统（试做版）===========&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;\t\t\t1. 用户登录&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;\t\t\t9. 退出系统&quot;</span>);</span><br><span class="line">            System.out.print(<span class="string">&quot;请输入：&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">inpString</span> <span class="operator">=</span> Utility.readKeyBoard(<span class="number">1</span>, <span class="literal">false</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;--------------------------------------------&quot;</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (inpString.equals(<span class="string">&quot;1&quot;</span>)) &#123;</span><br><span class="line">                    menuLogin_0_1();</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (inpString.equals(<span class="string">&quot;9&quot;</span>)) &#123;</span><br><span class="line">                    running0 = <span class="literal">false</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RuntimeException | ClassNotFoundException e) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;错误&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException d) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;链接失败！&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;--------------------------------------------&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;再见~&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//一级菜单、登录</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">menuLogin_0_1</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;-----------------用户登录-------------------&quot;</span>);</span><br><span class="line">        System.out.print(<span class="string">&quot;请输入用户ID（4位）：&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> Utility.readKeyBoard(<span class="number">4</span>, <span class="literal">false</span>);</span><br><span class="line">        System.out.print(<span class="string">&quot;请输入密码（6位）：&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">pw</span> <span class="operator">=</span> Utility.readKeyBoard(<span class="number">6</span>, <span class="literal">false</span>);</span><br><span class="line">        System.out.println();</span><br><span class="line">        System.out.println(<span class="string">&quot;--------------------------------------------&quot;</span>);</span><br><span class="line">        user = <span class="keyword">new</span> <span class="title class_">User</span>(id, pw);</span><br><span class="line">        loggedUser = tryLogin_0_1_1(user);</span><br><span class="line">        <span class="keyword">if</span> (loggedUser == <span class="literal">null</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;登录失败&quot;</span>);</span><br><span class="line">            oos.close();</span><br><span class="line">            ois.close();</span><br><span class="line">            socket.close();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;欢迎回来，&quot;</span> + loggedUser.getName());</span><br><span class="line">            isLoggedIn_1();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> UserData <span class="title function_">tryLogin_0_1_1</span><span class="params">(User user)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        socket = <span class="keyword">new</span> <span class="title class_">Socket</span>(InetAddress.getByName(serverIP), <span class="number">9000</span>);</span><br><span class="line">        oos = <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(socket.getOutputStream());</span><br><span class="line">        ois = <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(socket.getInputStream());</span><br><span class="line">        oos.writeObject(user);</span><br><span class="line">        <span class="type">Message</span> <span class="variable">received</span> <span class="operator">=</span> (Message) ois.readObject();</span><br><span class="line">        <span class="type">String</span> <span class="variable">reply</span> <span class="operator">=</span> received.getMessageType();</span><br><span class="line">        <span class="keyword">if</span> (reply.equals(MessageType.LOGIN_WRONG_PW)) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;密码错误&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (reply.equals(MessageType.LOGIN_USER_NOT_EXIST)) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;用户名不存在&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (reply.equals(MessageType.LOGIN_SUCCESS)) &#123;</span><br><span class="line">            <span class="keyword">return</span> (UserData) received.getObject();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (reply.equals(MessageType.LOGIN_FAILED)) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;错误&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//二级菜单</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">isLoggedIn_1</span><span class="params">()</span> &#123;</span><br><span class="line">        ct = <span class="keyword">new</span> <span class="title class_">ClientThread</span>(socket, oos, ois, <span class="built_in">this</span>);</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(ct).start();</span><br><span class="line">        running = <span class="literal">true</span>;</span><br><span class="line">        showBasicMenu_1_();</span><br><span class="line">        System.out.println(loggedUser.leftMessage);</span><br><span class="line">        cancelMenu = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (loggedUser.leftMessage.length() != <span class="number">0</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;----------------以上是留言----------------&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (running) &#123;</span><br><span class="line">            showBasicMenu_1_();</span><br><span class="line">            System.out.print(<span class="string">&quot;请选择：&quot;</span>);</span><br><span class="line">            <span class="type">char</span> <span class="variable">inp</span> <span class="operator">=</span> Utility.readChar();</span><br><span class="line">            System.out.println(<span class="string">&quot;--------------------------------------------&quot;</span>);</span><br><span class="line">            <span class="keyword">switch</span> (inp) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;1&#x27;</span>:</span><br><span class="line">                    loggedGetList_1_1();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;2&#x27;</span>:</span><br><span class="line">                    loggedChat_1_2();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;3&#x27;</span>:</span><br><span class="line">                    loggedGroupChat_1_3();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;4&#x27;</span>:</span><br><span class="line">                    loggedSendFile_1_4();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;5&#x27;</span>:</span><br><span class="line">                    loggedChangeName_1_5();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;6&#x27;</span>:</span><br><span class="line">                    loggedChangePw_1_6();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;7&#x27;</span>:</span><br><span class="line">                    loggedChangeHide_1_7();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;8&#x27;</span>:</span><br><span class="line">                    showOthersMenu_1_();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;9&#x27;</span>:</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        loggedLogout_1_9();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                        System.out.println(<span class="string">&quot;复位&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;M&#x27;</span>:</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;m&#x27;</span>:</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;L&#x27;</span>:</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;l&#x27;</span>:</span><br><span class="line">                    loggedShowLeftMessage_1_L();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;H&#x27;</span>:</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;h&#x27;</span>:</span><br><span class="line">                    loggedShowChatMessage_1_H();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;C&#x27;</span>:</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;c&#x27;</span>:</span><br><span class="line">                    loggedClearMessage_1_C();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;D&#x27;</span>:</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;d&#x27;</span>:</span><br><span class="line">                    loggedFileDeal_1_D();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;F&#x27;</span>:</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;f&#x27;</span>:</span><br><span class="line">                    loggedShowFilePath_1_F();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;N&#x27;</span>:</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;n&#x27;</span>:</span><br><span class="line">                    loggedChangeFilePath_1_N();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    System.out.println(<span class="string">&quot;错误：请检查输入内容&quot;</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">showBasicMenu_1_</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (cancelMenu) &#123;</span><br><span class="line">            cancelMenu = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;================&quot;</span> + loggedUser.getName() + <span class="string">&quot;（&quot;</span> + loggedUser.getID() + <span class="string">&quot;）================&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;\t\t\t1. 获取用户列表&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;\t\t\t2. 聊天&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;\t\t\t3. 群聊&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;\t\t\t4. 发送文件&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;\t\t\t5. 修改昵称&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;\t\t\t6. 修改密码&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;\t\t\t7. 切换隐身状态（目前：&quot;</span> + (loggedUser.isOnline() ? <span class="string">&quot;非隐身）&quot;</span> : <span class="string">&quot;隐身★~）&quot;</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;\t\t\t8. 其他&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;\t\t\t9. 退出&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;--------------------------------------------&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">showOthersMenu_1_</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;================&quot;</span> + loggedUser.getName() + <span class="string">&quot;（&quot;</span> + loggedUser.getID() + <span class="string">&quot;）================&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;\t\t\tC. 清空在线消息&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;\t\t\tD. 查看文件&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;\t\t\tH. 在线消息记录&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;\t\t\tL. 查看离线留言&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;\t\t\tF. 查看文件存放目录&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;\t\t\tN. 更改文件存放目录&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;\t\t\tM. 返回（显示一级菜单）&quot;</span>);</span><br><span class="line">        cancelMenu = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">loggedGetList_1_1</span><span class="params">()</span> &#123;</span><br><span class="line">        message = <span class="keyword">new</span> <span class="title class_">Message</span>(<span class="literal">null</span>, loggedUser.getID(), serverIP, MessageType.LOGGED_SHOW_LIST);</span><br><span class="line">        sendAndReceive();</span><br><span class="line">        <span class="keyword">if</span> (message == <span class="literal">null</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;获取列表失败&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (message.getMessageType().equals(MessageType.REQUEST_ALLOWED)) &#123;</span><br><span class="line">            ct.messageReceived = <span class="literal">false</span>;</span><br><span class="line">            System.out.println(<span class="string">&quot;----------------成员列表如下----------------&quot;</span>);</span><br><span class="line">            System.out.println(message.getMessage());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;获取列表失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">loggedGetActiveList_1_1A</span><span class="params">()</span> &#123;</span><br><span class="line">        message = <span class="keyword">new</span> <span class="title class_">Message</span>(<span class="literal">null</span>, loggedUser.getID(), serverIP, MessageType.LOGGED_SHOW_ONLINE_LIST);</span><br><span class="line">        sendAndReceive();</span><br><span class="line">        <span class="keyword">if</span> (message == <span class="literal">null</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;获取在线成员列表失败&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (message.getMessageType().equals(MessageType.REQUEST_ALLOWED)) &#123;</span><br><span class="line">            ct.messageReceived = <span class="literal">false</span>;</span><br><span class="line">            System.out.println(<span class="string">&quot;--------------在线成员列表如下--------------&quot;</span>);</span><br><span class="line">            System.out.println(message.getMessage());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;获取在线成员列表失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">loggedChat_1_2</span><span class="params">()</span> &#123;</span><br><span class="line">        loggedGetActiveList_1_1A();</span><br><span class="line">        message = <span class="keyword">new</span> <span class="title class_">Message</span>(<span class="literal">null</span>, loggedUser.getID(), serverIP, MessageType.CHAT);</span><br><span class="line">        System.out.print(<span class="string">&quot;请输入私聊对象：&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">tarId</span> <span class="operator">=</span> Utility.readKeyBoard(<span class="number">10</span>, <span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (tarId == <span class="literal">null</span> || tarId.equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;取消&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tarId.equals(loggedUser.getID())) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;不能私聊自己&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.print(<span class="string">&quot;发送内容：&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">word</span> <span class="operator">=</span> Utility.readKeyBoard(<span class="number">100</span>, <span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (word == <span class="literal">null</span> || word.equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;取消&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        User[] temp = <span class="keyword">new</span> <span class="title class_">User</span>[<span class="number">2</span>];</span><br><span class="line">        temp[<span class="number">0</span>] = user;</span><br><span class="line">        temp[<span class="number">1</span>] = <span class="keyword">new</span> <span class="title class_">User</span>(tarId, <span class="literal">null</span>);</span><br><span class="line">        message.setObject(temp);</span><br><span class="line">        message.setMessage(word);</span><br><span class="line">        showBasicMenu_1_();</span><br><span class="line">        sendAndReceive();</span><br><span class="line">        <span class="keyword">if</span> (message == <span class="literal">null</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;\r访问失败&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (message.getMessageType().equals(MessageType.REQUEST_ALLOWED)) &#123;</span><br><span class="line">            ct.sb.append(<span class="string">&quot;\n&quot;</span>).append(message.getTime()).append(<span class="string">&quot; 你对 &quot;</span>).append(((User) message.getObject()).getId()).append(<span class="string">&quot; 说：&quot;</span>).append(word);</span><br><span class="line">            System.out.println(ct.sb);</span><br><span class="line">            System.out.println(<span class="string">&quot;\r发送成功&quot;</span>);</span><br><span class="line">            cancelMenu = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (message.getMessageType().equals(MessageType.REQUEST_REJECTED)) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;\r请求被拒绝&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;\r发送失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">loggedGroupChat_1_3</span><span class="params">()</span> &#123;</span><br><span class="line">        message = <span class="keyword">new</span> <span class="title class_">Message</span>(<span class="literal">null</span>, loggedUser.getID(), serverIP, MessageType.GROUP_CHAT);</span><br><span class="line">        System.out.print(<span class="string">&quot;发送内容：&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">word</span> <span class="operator">=</span> Utility.readKeyBoard(<span class="number">100</span>, <span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (word == <span class="literal">null</span> || word.equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;取消&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        message.setObject(user);</span><br><span class="line">        message.setMessage(word);</span><br><span class="line">        showBasicMenu_1_();</span><br><span class="line">        sendAndReceive();</span><br><span class="line">        <span class="keyword">if</span> (message == <span class="literal">null</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;\r访问失败&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (message.getMessageType().equals(MessageType.REQUEST_ALLOWED)) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;\r发送成功&quot;</span>);</span><br><span class="line">            cancelMenu = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (message.getMessageType().equals(MessageType.REQUEST_REJECTED)) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;\r请求被拒绝&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;\r发送失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">loggedSendFile_1_4</span><span class="params">()</span> &#123;</span><br><span class="line">        loggedGetActiveList_1_1A();</span><br><span class="line">        message = <span class="keyword">new</span> <span class="title class_">Message</span>(<span class="literal">null</span>, loggedUser.getID(), serverIP, MessageType.FILE);</span><br><span class="line">        System.out.println(<span class="string">&quot;请输入要发送的用户：&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">tar</span> <span class="operator">=</span> Utility.readKeyBoard(<span class="number">4</span>, <span class="literal">true</span>);</span><br><span class="line">        message.setReceiver(tar);</span><br><span class="line">        <span class="keyword">if</span> (tar == <span class="literal">null</span> || tar.equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;取消&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tar.equals(loggedUser.getID())) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;错误：不能发给自己&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tar.length() &lt; <span class="number">4</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;错误：用户 ID 是 4 位字符&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.print(<span class="string">&quot;请输入文件完整路径：&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">file_Str</span> <span class="operator">=</span> Utility.readKeyBoard(<span class="number">500</span>, <span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (file_Str == <span class="literal">null</span> || file_Str.equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;取消&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        cancelMenu = <span class="literal">true</span>;</span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">byte</span>[] data = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            file = <span class="keyword">new</span> <span class="title class_">File</span>(file_Str);</span><br><span class="line">            <span class="keyword">if</span> (!file.isFile()) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            data = Utility.loadFile(file);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            showBasicMenu_1_();</span><br><span class="line">            System.out.println(<span class="string">&quot;错误：文件路径错误&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        message.setSender(loggedUser.getPw());</span><br><span class="line">        message.setObject(data);</span><br><span class="line">        message.setMessage(file.getName());</span><br><span class="line">        sendAndReceive();</span><br><span class="line">        <span class="keyword">if</span> (message == <span class="literal">null</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;发送失败&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (message.getMessageType().equals(MessageType.REQUEST_ALLOWED)) &#123;</span><br><span class="line">            ct.messageReceived = <span class="literal">false</span>;</span><br><span class="line">            System.out.println(<span class="string">&quot;文件发送成功&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (message.getMessageType().equals(MessageType.REQUEST_REJECTED)) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;请求被拒绝&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;请求失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        cancelMenu = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">loggedChangeName_1_5</span><span class="params">()</span> &#123;</span><br><span class="line">        message = <span class="keyword">new</span> <span class="title class_">Message</span>(<span class="literal">null</span>, loggedUser.getID(), serverIP, MessageType.LOGGED_CHANGE_NAME);</span><br><span class="line">        System.out.print(<span class="string">&quot;请输入一个新名字（不超过10位）：&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">newName</span> <span class="operator">=</span> Utility.readKeyBoard(<span class="number">10</span>, <span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (newName == <span class="literal">null</span> || newName.equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;取消&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        message.setMessage(newName);</span><br><span class="line">        message.setObject(loggedUser);</span><br><span class="line">        loggedUser = <span class="literal">null</span>;</span><br><span class="line">        sendAndReceive();</span><br><span class="line">        <span class="keyword">if</span> (message == <span class="literal">null</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;访问失败&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (message.getMessageType().equals(MessageType.REQUEST_ALLOWED)) &#123;</span><br><span class="line">            ct.messageReceived = <span class="literal">false</span>;</span><br><span class="line">            loggedUser = (UserData) message.getObject();</span><br><span class="line">            System.out.println(<span class="string">&quot;修改完毕：（&quot;</span> + loggedUser.getID() + <span class="string">&quot;）&quot;</span> + loggedUser.getName());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (message.getMessageType().equals(MessageType.REQUEST_REJECTED)) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;请求被拒绝&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;请求失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">loggedChangePw_1_6</span><span class="params">()</span> &#123;</span><br><span class="line">        message = <span class="keyword">new</span> <span class="title class_">Message</span>(<span class="literal">null</span>, loggedUser.getID(), serverIP, MessageType.LOGGED_CHANGE_PW);</span><br><span class="line">        System.out.print(<span class="string">&quot;请输入原密码：&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">pw</span> <span class="operator">=</span> Utility.readKeyBoard(<span class="number">20</span>, <span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (pw == <span class="literal">null</span> || pw.equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;取消&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!pw.equals(loggedUser.getPw())) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;错误：密码错误&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.print(<span class="string">&quot;请输入新密码（6位）：&quot;</span>);</span><br><span class="line">        pw = Utility.readKeyBoard(<span class="number">6</span>, <span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (pw == <span class="literal">null</span> || pw.equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;取消&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pw.length() != <span class="number">6</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;错误：密码长度应该是 6 位&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        message.setMessage(pw);</span><br><span class="line">        message.setObject(loggedUser);</span><br><span class="line">        sendAndReceive();</span><br><span class="line">        <span class="keyword">if</span> (message == <span class="literal">null</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;访问失败&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (message.getMessageType().equals(MessageType.REQUEST_ALLOWED)) &#123;</span><br><span class="line">            ct.messageReceived = <span class="literal">false</span>;</span><br><span class="line">            System.out.println(<span class="string">&quot;密码修改成功&quot;</span>);</span><br><span class="line">            loggedUser = (UserData) message.getObject();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (message.getMessageType().equals(MessageType.REQUEST_REJECTED)) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;请求被拒绝&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;请求失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">loggedChangeHide_1_7</span><span class="params">()</span> &#123;</span><br><span class="line">        message = <span class="keyword">new</span> <span class="title class_">Message</span>(<span class="literal">null</span>, loggedUser.getID(), serverIP, MessageType.LOGGED_CHANGE_HIDE);</span><br><span class="line">        message.setObject(loggedUser);</span><br><span class="line"><span class="comment">//        loggedUser = null;</span></span><br><span class="line">        sendAndReceive();</span><br><span class="line">        <span class="keyword">if</span> (message == <span class="literal">null</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;访问失败&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (message.getMessageType().equals(MessageType.REQUEST_ALLOWED)) &#123;</span><br><span class="line">            loggedUser = (UserData) message.getObject();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (message.getMessageType().equals(MessageType.REQUEST_REJECTED)) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;请求被拒绝&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;请求失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">loggedLogout_1_9</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;确认退出吗？（Y/N）&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (Utility.readConfirmSelection() == <span class="string">&#x27;Y&#x27;</span>) &#123;</span><br><span class="line">            message = <span class="keyword">new</span> <span class="title class_">Message</span>(<span class="literal">null</span>, loggedUser.getID(), serverIP, MessageType.LOGGED_LOGOUT);</span><br><span class="line">            message.setObject(loggedUser);</span><br><span class="line">            oos.writeObject(message);</span><br><span class="line">            loggedUser = <span class="literal">null</span>;</span><br><span class="line">            socket.close();</span><br><span class="line">            ct.running = <span class="literal">false</span>;</span><br><span class="line">            running = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">loggedShowChatMessage_1_H</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(ct.sb);</span><br><span class="line">        cancelMenu = <span class="literal">true</span>;</span><br><span class="line">        System.out.println(<span class="string">&quot;----------------没有更多了----------------&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">loggedShowLeftMessage_1_L</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(loggedUser.leftMessage);</span><br><span class="line">        cancelMenu = <span class="literal">true</span>;</span><br><span class="line">        System.out.println(<span class="string">&quot;----------------没有更多了----------------&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">loggedClearMessage_1_C</span><span class="params">()</span> &#123;</span><br><span class="line">        ct.sb.delete(<span class="number">0</span>, ct.sb.length());</span><br><span class="line">        System.out.println(<span class="string">&quot;完成&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">loggedFileDeal_1_D</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">fileMenuRunning</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">while</span> (fileMenuRunning) &#123;</span><br><span class="line">            showFileDealMenu_1_D_();</span><br><span class="line">            System.out.print(<span class="string">&quot;请选择：&quot;</span>);</span><br><span class="line">            <span class="type">char</span> <span class="variable">inp</span> <span class="operator">=</span> Utility.readChar();</span><br><span class="line">            System.out.println(<span class="string">&quot;--------------------------------------------&quot;</span>);</span><br><span class="line">            <span class="keyword">switch</span> (inp) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;1&#x27;</span>:</span><br><span class="line">                    fileShowAllName_1_D_1();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;2&#x27;</span>:</span><br><span class="line">                    fileShowNewestName_1_D_2();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;3&#x27;</span>:</span><br><span class="line">                    fileDeleteNewestOne_1_D_3();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;4&#x27;</span>:</span><br><span class="line">                    fileDownloadNewestOne_1_D_4();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;5&#x27;</span>:</span><br><span class="line">                    fileDownloadAll_1_D_5();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;6&#x27;</span>:</span><br><span class="line">                    loggedChangeFilePath_1_N();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;9&#x27;</span>:</span><br><span class="line">                    fileMenuRunning = <span class="literal">false</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    System.out.println(<span class="string">&quot;错误：请检查输入内容&quot;</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">showFileDealMenu_1_D_</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (cancelMenu) &#123;</span><br><span class="line">            cancelMenu = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;---------------文件管理----------------&quot;</span>);</span><br><span class="line">        ct.showFilesRemain();</span><br><span class="line">        loggedShowFilePath_1_F();</span><br><span class="line">        System.out.println(<span class="string">&quot;-------------------------------------&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;\t\t\t1. 查看所有文件&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;\t\t\t2. 查看最新文件&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;\t\t\t3. 删除最新的文件&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;\t\t\t4. 下载最新的文件&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;\t\t\t5. 全部下载&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;\t\t\t6. 修改存放路径&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;\t\t\t9. 返回上级目录&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">fileShowAllName_1_D_1</span><span class="params">()</span> &#123;</span><br><span class="line">        showFileDealMenu_1_D_();</span><br><span class="line">        cancelMenu = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (ct.filesToDeal.length == <span class="number">0</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;没有未处理的文件了★~~&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            System.out.println((n + <span class="number">1</span>) + <span class="string">&quot;. &quot;</span> + ct.fileName[n]);</span><br><span class="line">        &#125; <span class="keyword">while</span> (++n &lt; ct.fileName.length);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">fileShowNewestName_1_D_2</span><span class="params">()</span> &#123;</span><br><span class="line">        showFileDealMenu_1_D_();</span><br><span class="line">        cancelMenu = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (ct.filesToDeal.length == <span class="number">0</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;没有未处理的文件了★~~&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(ct.fileName.length + <span class="string">&quot;. &quot;</span> + ct.fileName[ct.fileName.length - <span class="number">1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">fileDeleteNewestOne_1_D_3</span><span class="params">()</span> &#123;</span><br><span class="line">        showFileDealMenu_1_D_();</span><br><span class="line">        cancelMenu = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (ct.filesToDeal.length == <span class="number">0</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;没有未处理的文件了★~~&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(ct.fileName.length + <span class="string">&quot;. &quot;</span> + ct.fileName[ct.fileName.length - <span class="number">1</span>]);</span><br><span class="line">        System.out.println(<span class="string">&quot;确定删除吗？&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;确认退出吗？（Y/N）&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (Utility.readConfirmSelection() == <span class="string">&#x27;N&#x27;</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;取消&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (ct.deleteNewestFile()) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;删除成功&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">fileDownloadNewestOne_1_D_4</span><span class="params">()</span> &#123;</span><br><span class="line">        showFileDealMenu_1_D_();</span><br><span class="line">        cancelMenu = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (ct.filesToDeal.length == <span class="number">0</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;没有未处理的文件了★~~&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> ct.fileName[ct.fileName.length - <span class="number">1</span>];</span><br><span class="line">        <span class="keyword">if</span> (ct.downloadNewestFile()) &#123;</span><br><span class="line">            System.out.println(str + <span class="string">&quot; 下载成功&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">fileDownloadAll_1_D_5</span><span class="params">()</span> &#123;</span><br><span class="line">        showFileDealMenu_1_D_();</span><br><span class="line">        cancelMenu = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (ct.filesToDeal.length == <span class="number">0</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;没有未处理的文件了★~~&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            fileDownloadNewestOne_1_D_4();</span><br><span class="line">        &#125; <span class="keyword">while</span> (ct.filesToDeal.length &gt; <span class="number">0</span>);</span><br><span class="line">        cancelMenu = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">loggedShowFilePath_1_F</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;文件保存目录如下：&quot;</span> + filePath);</span><br><span class="line">        cancelMenu = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">loggedChangeFilePath_1_N</span><span class="params">()</span> &#123;</span><br><span class="line">        loggedShowFilePath_1_F();</span><br><span class="line">        System.out.print(<span class="string">&quot;请输入一个新的路径&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">newPath</span> <span class="operator">=</span> Utility.readKeyBoard(<span class="number">500</span>, <span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (newPath == <span class="literal">null</span> || newPath.equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;取消&quot;</span>);</span><br><span class="line">            cancelMenu = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        File path;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            path = <span class="keyword">new</span> <span class="title class_">File</span>(newPath);</span><br><span class="line">            path.mkdir();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;错误：路径输入错误&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        filePath = path;</span><br><span class="line">        cancelMenu = <span class="literal">false</span>;</span><br><span class="line">        showBasicMenu_1_();</span><br><span class="line">        System.out.println(<span class="string">&quot;成功&quot;</span>);</span><br><span class="line">        loggedShowFilePath_1_F();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sendAndReceive</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">now</span> <span class="operator">=</span> (<span class="keyword">new</span> <span class="title class_">Date</span>()).getTime();</span><br><span class="line">        ct.messageReceived = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            oos.writeObject(message);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;异常&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">new</span> <span class="title class_">Date</span>().getTime() - now &gt;= <span class="number">5000</span>) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;超时&quot;</span>);</span><br><span class="line">                message = <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ct.messageReceived) &#123;</span><br><span class="line">                message = ct.message;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">while</span> (<span class="literal">true</span>);</span><br><span class="line">        ct.messageReceived = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">getDate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> getDate(LocalDateTime.now());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">getDate</span><span class="params">(LocalDateTime ldt)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ldt.getYear() + <span class="string">&quot;.&quot;</span> + ldt.getMonthValue() + <span class="string">&quot;.&quot;</span> + ldt.getDayOfMonth();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">getTime</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> getTime(LocalDateTime.now());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">getTime</span><span class="params">(LocalDateTime ldt)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ldt.getHour() + <span class="string">&quot;:&quot;</span> + ldt.getMinute() + <span class="string">&quot;:&quot;</span> + ldt.getSecond();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">getDateTime</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">ldt</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">        <span class="keyword">return</span> getDate(ldt) + <span class="string">&quot;  &quot;</span> + getTime();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    private Message packageMessage(String str) &#123;</span></span><br><span class="line"><span class="comment">//        return new Message(str, thisIP, serverIP, &quot;0&quot;);</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>ClientThread.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.melody.transmission.common;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Melody</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClientThread</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Socket socket;</span><br><span class="line">    <span class="keyword">private</span> ObjectOutputStream oos;</span><br><span class="line">    <span class="keyword">private</span> ObjectInputStream ois;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="variable">messageReceived</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="variable">running</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">    <span class="keyword">private</span> ClientInterface ci;</span><br><span class="line">    <span class="comment">//    public byte[] fileToDeal;</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="variable">receivedFileDealt</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[][] filesToDeal = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">0</span>][];			<span class="comment">//这里改为创建一个本地缓存，在内存里存放路径更好</span></span><br><span class="line">    														<span class="comment">//但我懒得改了</span></span><br><span class="line">    <span class="keyword">public</span> String[] fileName = <span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (running) &#123;</span><br><span class="line">                message = (Message) ois.readObject();</span><br><span class="line">                <span class="keyword">if</span> (message.getMessageType().equals(MessageType.CHAT) || message.getMessageType().equals(MessageType.GROUP_CHAT)) &#123;</span><br><span class="line">                    chatReceived();</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (message.getMessageType().equals(MessageType.FILE)) &#123;</span><br><span class="line">                    filesReceived();</span><br><span class="line">                &#125;</span><br><span class="line">                messageReceived = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException | ClassNotFoundException e) &#123;</span><br><span class="line">            ci.running = <span class="literal">false</span>;</span><br><span class="line">            System.out.print(<span class="string">&quot;\r已离线：&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ClientThread</span><span class="params">(Socket socket, ObjectOutputStream oos, ObjectInputStream ois, ClientInterface ci)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.socket = socket;</span><br><span class="line">        <span class="built_in">this</span>.oos = oos;</span><br><span class="line">        <span class="built_in">this</span>.ois = ois;</span><br><span class="line">        <span class="built_in">this</span>.ci = ci;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Socket <span class="title function_">getSocket</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> socket;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">chatReceived</span><span class="params">()</span> &#123;</span><br><span class="line">        sb.append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        sb.append(message.getMessage());</span><br><span class="line">        System.out.println(<span class="string">&quot;\r&quot;</span>);</span><br><span class="line">        ci.showBasicMenu_1_();</span><br><span class="line">        System.out.print(<span class="string">&quot;\r          &quot;</span>);</span><br><span class="line">        System.out.print(<span class="string">&quot;\r&quot;</span> + sb);</span><br><span class="line">        System.out.print(<span class="string">&quot;\n请选择：&quot;</span>);</span><br><span class="line">        message.setMessageType(MessageType.REQUEST_ALLOWED);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">filesReceived</span><span class="params">()</span> &#123;</span><br><span class="line">        filesToDeal = Arrays.copyOf(filesToDeal, filesToDeal.length + <span class="number">1</span>);</span><br><span class="line">        filesToDeal[filesToDeal.length - <span class="number">1</span>] = (<span class="type">byte</span>[]) message.getObject();</span><br><span class="line">        fileName = Arrays.copyOf(fileName, fileName.length + <span class="number">1</span>);</span><br><span class="line">        fileName[fileName.length - <span class="number">1</span>] = message.getMessage();</span><br><span class="line">        receivedFileDealt = <span class="literal">false</span>;</span><br><span class="line">        showFilesRemain();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">showFilesRemain</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;\r★您有 &quot;</span> + filesToDeal.length + <span class="string">&quot; 个文件等待处理★&quot;</span>);</span><br><span class="line"><span class="comment">//        System.out.println(&quot;\r★按 D 键处理★&quot;);</span></span><br><span class="line">        <span class="keyword">if</span> (filesToDeal.length == <span class="number">0</span>)&#123;</span><br><span class="line">            receivedFileDealt = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">deleteNewestFile</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            filesToDeal = Arrays.copyOf(filesToDeal, filesToDeal.length - <span class="number">1</span>);</span><br><span class="line">            fileName = Arrays.copyOf(fileName, fileName.length - <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span> (fileName.length != filesToDeal.length)&#123;</span><br><span class="line">                fileName = Arrays.copyOf(fileName, filesToDeal.length - <span class="number">1</span>);</span><br><span class="line">                System.out.println(<span class="string">&quot;错误：文件或文件名丢失&quot;</span>);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            showFilesRemain();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">downloadNewestFile</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">File</span> <span class="variable">savePath</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(ci.filePath, fileName[fileName.length - <span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">if</span> (Utility.saveFile(filesToDeal[filesToDeal.length -<span class="number">1</span>], savePath))&#123;</span><br><span class="line">            <span class="keyword">return</span> deleteNewestFile();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;错误：文件存储失败&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>ClientThreadCollection.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.melody.transmission.common;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Melody</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClientThreadCollection</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> HashMap&lt;String, ClientThread&gt; threads = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">addSocket</span><span class="params">(String ip, ClientThread ct)</span> &#123;</span><br><span class="line">        threads.put(ip, ct);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ClientThread <span class="title function_">get</span><span class="params">(String ip)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> threads.get(ip);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Utility.java（工具类，不是我写的）</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.melody.transmission.common;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> 韩顺平</span></span><br><span class="line"><span class="comment"> * 工具类的作用:</span></span><br><span class="line"><span class="comment"> * 处理各种情况的用户输入，并且能够按照程序员的需求，得到用户的控制台输入。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.imageio.IIOException;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Utility</span> &#123;</span><br><span class="line">    <span class="comment">//静态属性。。。</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Scanner</span> <span class="variable">scanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 功能：读取键盘输入的一个菜单选项，值：1——5的范围</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 1——5</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">char</span> <span class="title function_">readMenuSelection</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">char</span> c;</span><br><span class="line">        <span class="keyword">for</span> (; ; ) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> readKeyBoard(<span class="number">1</span>, <span class="literal">false</span>);<span class="comment">//包含一个字符的字符串</span></span><br><span class="line">            c = str.charAt(<span class="number">0</span>);<span class="comment">//将字符串转换成字符char类型</span></span><br><span class="line">            <span class="keyword">if</span> (c != <span class="string">&#x27;1&#x27;</span> &amp;&amp; c != <span class="string">&#x27;2&#x27;</span> &amp;&amp;</span><br><span class="line">                    c != <span class="string">&#x27;3&#x27;</span> &amp;&amp; c != <span class="string">&#x27;4&#x27;</span> &amp;&amp; c != <span class="string">&#x27;5&#x27;</span>) &#123;</span><br><span class="line">                System.out.print(<span class="string">&quot;选择错误，请重新输入：&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> c;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 功能：读取键盘输入的一个字符</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 一个字符</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">char</span> <span class="title function_">readChar</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> readKeyBoard(<span class="number">1</span>, <span class="literal">false</span>);<span class="comment">//就是一个字符</span></span><br><span class="line">        <span class="keyword">return</span> str.charAt(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 功能：读取键盘输入的一个字符，如果直接按回车，则返回指定的默认值；否则返回输入的那个字符</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> defaultValue 指定的默认值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 默认值或输入的字符</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">char</span> <span class="title function_">readChar</span><span class="params">(<span class="type">char</span> defaultValue)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> readKeyBoard(<span class="number">1</span>, <span class="literal">true</span>);<span class="comment">//要么是空字符串，要么是一个字符</span></span><br><span class="line">        <span class="keyword">return</span> (str.length() == <span class="number">0</span>) ? defaultValue : str.charAt(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 功能：读取键盘输入的整型，长度小于2位</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 整数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">readInt</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">int</span> n;</span><br><span class="line">        <span class="keyword">for</span> (; ; ) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> readKeyBoard(<span class="number">10</span>, <span class="literal">false</span>);<span class="comment">//一个整数，长度&lt;=10位</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                n = Integer.parseInt(str);<span class="comment">//将字符串转换成整数</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">                System.out.print(<span class="string">&quot;数字输入错误，请重新输入：&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> n;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 功能：读取键盘输入的 整数或默认值，如果直接回车，则返回默认值，否则返回输入的整数</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> defaultValue 指定的默认值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 整数或默认值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">readInt</span><span class="params">(<span class="type">int</span> defaultValue)</span> &#123;</span><br><span class="line">        <span class="type">int</span> n;</span><br><span class="line">        <span class="keyword">for</span> (; ; ) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> readKeyBoard(<span class="number">10</span>, <span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (str.equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> defaultValue;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//异常处理...</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                n = Integer.parseInt(str);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">                System.out.print(<span class="string">&quot;数字输入错误，请重新输入：&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> n;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 功能：读取键盘输入的指定长度的字符串</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> limit 限制的长度</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 指定长度的字符串</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">readString</span><span class="params">(<span class="type">int</span> limit)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> readKeyBoard(limit, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 功能：读取键盘输入的指定长度的字符串或默认值，如果直接回车，返回默认值，否则返回字符串</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> limit        限制的长度</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> defaultValue 指定的默认值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 指定长度的字符串</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">readString</span><span class="params">(<span class="type">int</span> limit, String defaultValue)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> readKeyBoard(limit, <span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> str.equals(<span class="string">&quot;&quot;</span>) ? defaultValue : str;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 功能：读取键盘输入的确认选项，Y或N</span></span><br><span class="line"><span class="comment">     * 将小的功能，封装到一个方法中.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Y或N</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">char</span> <span class="title function_">readConfirmSelection</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="comment">//        System.out.println(&quot;请输入你的选择(Y/N): 请小心选择&quot;);</span></span><br><span class="line">        <span class="type">char</span> c;</span><br><span class="line">        <span class="keyword">for</span> (; ; ) &#123;<span class="comment">//无限循环</span></span><br><span class="line">            <span class="comment">//在这里，将接受到字符，转成了大写字母</span></span><br><span class="line">            <span class="comment">//y =&gt; Y n=&gt;N</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> readKeyBoard(<span class="number">1</span>, <span class="literal">false</span>).toUpperCase();</span><br><span class="line">            c = str.charAt(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (c == <span class="string">&#x27;Y&#x27;</span> || c == <span class="string">&#x27;N&#x27;</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                System.out.print(<span class="string">&quot;请重新输入（输入 Y/N）：&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> c;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 功能： 读取一个字符串</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> limit       读取的长度</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> blankReturn 如果为true ,表示 可以读空字符串。</span></span><br><span class="line"><span class="comment">     *                    如果为false表示 不能读空字符串。</span></span><br><span class="line"><span class="comment">     *                    &lt;p&gt;</span></span><br><span class="line"><span class="comment">     *                    如果输入为空，或者输入大于limit的长度，就会提示重新输入。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">readKeyBoard</span><span class="params">(<span class="type">int</span> limit, <span class="type">boolean</span> blankReturn)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//定义了字符串</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">line</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="comment">//scanner.hasNextLine() 判断有没有下一行</span></span><br><span class="line">        <span class="keyword">while</span> (scanner.hasNextLine()) &#123;</span><br><span class="line">            line = scanner.nextLine();<span class="comment">//读取这一行</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//如果line.length=0, 即用户没有输入任何内容，直接回车</span></span><br><span class="line">            <span class="keyword">if</span> (line.length() == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (blankReturn) <span class="keyword">return</span> line;<span class="comment">//如果blankReturn=true,可以返回空串</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">continue</span>; <span class="comment">//如果blankReturn=false,不接受空串，必须输入内容</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//如果用户输入的内容大于了 limit，就提示重写输入</span></span><br><span class="line">            <span class="comment">//0 &lt; 如果用户如的内容  &lt;= limit ,我就接受</span></span><br><span class="line">            <span class="keyword">if</span> (line.length() &lt; <span class="number">1</span> || line.length() &gt; limit) &#123;</span><br><span class="line">                System.out.print(<span class="string">&quot;输入长度（不能大于&quot;</span> + limit + <span class="string">&quot;）错误，请重新输入：&quot;</span>);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> line;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] receiveFile(InputStream is) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="keyword">while</span> ((len = is.read(bytes, <span class="number">0</span>, bytes.length)) != -<span class="number">1</span>) &#123;</span><br><span class="line">            bis.write(bytes, <span class="number">0</span>, len);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bis.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] loadFile(File path) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">is</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(path);</span><br><span class="line">        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="keyword">while</span> ((len = is.read(bytes, <span class="number">0</span>, bytes.length)) != -<span class="number">1</span>) &#123;</span><br><span class="line">            bis.write(bytes, <span class="number">0</span>, len);</span><br><span class="line">        &#125;</span><br><span class="line">        bytes = bis.toByteArray();</span><br><span class="line">        bis.close();</span><br><span class="line">        <span class="keyword">return</span> bytes;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">saveFile</span><span class="params">(<span class="type">byte</span>[] data, File path)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">        <span class="type">File</span> <span class="variable">temp</span> <span class="operator">=</span> path;</span><br><span class="line">        <span class="keyword">while</span> (temp.isFile()) &#123;</span><br><span class="line">            temp = <span class="keyword">new</span> <span class="title class_">File</span>(path.getParent(), <span class="string">&quot;（拷贝&quot;</span> + n++ + <span class="string">&quot;）&quot;</span> + path.getName());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">FileOutputStream</span> <span class="variable">is</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(temp);</span><br><span class="line">            is.write(data);</span><br><span class="line">            is.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/01/16/20%20%E9%A1%B9%E7%9B%AE%EF%BC%9A%E5%A4%9A%E7%94%A8%E6%88%B7%E9%80%9A%E8%AE%AF%E7%B3%BB%E7%BB%9F/" data-id="cl9a9e9710013ewtfgeup20jz" data-title="&lt;Java&gt;20 项目（多用户通讯系统）" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/" rel="tag">Java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%A8%8B%E5%BA%8F/" rel="tag">程序</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%AC%94%E8%AE%B0/" rel="tag">笔记</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2022/01/20/21%20%E5%8F%8D%E5%B0%84/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          &lt;Java&gt;21 反射
        
      </div>
    </a>
  
  
    <a href="/2022/01/12/19%20%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">&lt;Java&gt;19 网络编程</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/" rel="tag">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%9B%AE%E5%BD%95/" rel="tag">目录</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%A8%8B%E5%BA%8F/" rel="tag">程序</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%AC%94%E8%AE%B0/" rel="tag">笔记</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Java/" style="font-size: 20px;">Java</a> <a href="/tags/%E7%9B%AE%E5%BD%95/" style="font-size: 10px;">目录</a> <a href="/tags/%E7%A8%8B%E5%BA%8F/" style="font-size: 15px;">程序</a> <a href="/tags/%E7%AC%94%E8%AE%B0/" style="font-size: 20px;">笔记</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/10/">October 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">June 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/05/">May 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">April 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/03/">March 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">February 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">January 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">December 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/11/">November 2021</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/10/16/hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/2022/06/03/26%20%E7%AE%97%E6%B3%95%E5%85%A5%E9%97%A8/">&lt;Java&gt;26 算法入门</a>
          </li>
        
          <li>
            <a href="/2022/06/02/14%20%E6%A0%91/">&lt;Java&gt;14 树</a>
          </li>
        
          <li>
            <a href="/2022/05/29/13%20Java%20%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">&lt;Java&gt;13 Java 数据结构</a>
          </li>
        
          <li>
            <a href="/2022/04/22/15%20%E5%9B%BE%E5%BD%A2%E7%95%8C%E9%9D%A2%E8%AE%BE%E8%AE%A1/">&lt;Java&gt;15 图形界面设计</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2022 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>